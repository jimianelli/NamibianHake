---
title: "Namibian hake model update, 2024"
author: "John Kathena, Jim Ianelli"
date: today
prefer-html: true
vignette: >

  %\VignetteIndexEntry{Model update}
  %\VignetteEngine{quarto::html}
  %\VignetteEncoding{UTF-8}
---


## Example model runs

Below are examples which show how models can be run based on the directory location.

### Model descriptions

The following table was developed based on testing the model with different assumptions and data sources.
Key differences from the 2023 assessment configuration was the assumption that 
model estimation of variance terms was appropriate. This feature resulted in unacceptable 
residual patterns and essentially a complete down weighting of the index data.
We used the assumed variance terms (CVs) for the indices in all of the following 
model configurations:

| Model | Description    |
|----------------------|--------------------------------------------------|
| Basecase (bc)  | Model with survey "minus group" to be ages 0, and 1 instead of 0, 1, and 2 as done in the past, steepness fixed at 0.7, q estimated, and time-varying fishery asymptotic selectivity specified.|
| m1  | As base case but with survey catchability fixed at 1.0 |
| m2  | As base case but with survey catchability fixed at 0.5 |
| m3  | As base case but with natural mortality estimated   |
| m4  | As base case but with fishery selectivity allowed to be dome-shaped |
| m5  | As base case but with stock-recruit steepness fixed at 0.43 |
| m6  | As base case but with stock-recruit steepness fixed at 0.9  |
| m7  | As base case but with early indices dropped (pre 1990)      |

```{r startup}
#| echo: false
#| output: false

library(NamibianHake)
## basic example code
library(here)
library(tidyverse)
library(ggridges)
theme_set(ggthemes::theme_few())
```

```{r getmods}
#| echo: false
#| output: false
bc <- run_nh("bc", runit = FALSE)
m1 <- run_nh("m1", runit = FALSE)
m2 <- run_nh("m2", runit = FALSE)
m3 <- run_nh("m3", runit = FALSE)
m5 <- run_nh("m5", runit = FALSE)
m6 <- run_nh("m6", runit = FALSE)
mods <- rbind(
  read_csv(here("mods", "bc", "nh_out.csv")) |> mutate(Model = "Base Case"),
  read_csv(here("mods", "m1", "nh_out.csv")) |> mutate(Model = "Model 1"),
  read_csv(here("mods", "m2", "nh_out.csv")) |> mutate(Model = "Model 2"),
  read_csv(here("mods", "m3", "nh_out.csv")) |> mutate(Model = "Model 3")
)

df <- rbind(
  data.frame(SSB = bc$SSB, R = bc$Pred_Rec, Model = "Base Case"),
  data.frame(SSB = m1$SSB, R = m1$Pred_Rec, Model = "Model 1"),
  data.frame(SSB = m2$SSB, R = m2$Pred_Rec, Model = "Model 2"),
  data.frame(SSB = m3$SSB, R = m3$Pred_Rec, Model = "Model 3"),
  data.frame(SSB = m5$SSB, R = m5$Pred_Rec, Model = "Model 5"),
  data.frame(SSB = m6$SSB, R = m6$Pred_Rec, Model = "Model 6")
)
bc <- run_nh("bc",runit=FALSE)
m1 <- run_nh("m1",runit=FALSE)
m2 <- run_nh("m2",runit=FALSE)
m3 <- run_nh("m3",runit=FALSE)
m5 <- run_nh("m5",runit=FALSE)
m6 <- run_nh("m6",runit=FALSE)
mods <-  rbind(
    read_csv(here("mods", "bc", "nh_out.csv")) |> mutate(Model = "Base Case"),
    read_csv(here("mods", "m1", "nh_out.csv")) |> mutate(Model = "Model 1"),
    read_csv(here("mods", "m2", "nh_out.csv")) |> mutate(Model = "Model 2"),
    read_csv(here("mods", "m3", "nh_out.csv")) |> mutate(Model = "Model 3")
    )
  
df <- rbind(
    data.frame(SSB = bc$SSB, R = bc$Pred_Rec, Model = "Base Case"),
    data.frame(SSB = m1$SSB, R = m1$Pred_Rec, Model = "Model 1"),
    data.frame(SSB = m2$SSB, R = m2$Pred_Rec, Model = "Model 2"),
    data.frame(SSB = m3$SSB, R = m3$Pred_Rec, Model = "Model 3") ,
    data.frame(SSB = m5$SSB, R = m5$Pred_Rec, Model = "Model 5") ,
    data.frame(SSB = m6$SSB, R = m6$Pred_Rec, Model = "Model 6") 
  ) 
>>>>>>> d3b4ea8 (vign)
>>>>>>> bca1eb7 (Style code (GHA))
>>>>>>> 8b96b42 (Style code (GHA))
>>>>>>> 4a59f50 (Style code (GHA))
```


## Model runs

### Stock-recruitment curves

The following plot shows the stock-recruitment curves for the base case and models 1, 2, 3, and 5 and 6.

```{r srrplots}
#| echo: false
#| fig.cap: "Model runs"
p1 <- df %>% ggplot(aes(x = SSB, y = R, color = Model, shape = Model)) +
  geom_point() +
  geom_line()
p1
```

### Age composition fits

```{r agecomps}
#| echo: false
#| fig.cap: "Base case model fits to survey and fishery age composition data. Note that the 
#| base case model uses a 'minus group' equal to '1' for the survey data."
PlotAgeFit(x=bc, title="Base case",type="fishery",fage=2,lage=7)
PlotAgeFit(x=bc, title="Base case",type="survey1",fage=1,lage=7)

```

### Selectivity
```{r selex}
#| echo: false
#| fig.cap: "Selectivity estimates for the base-case model run."
#| fig.width: 4
#| fig.height: 9

M <- data.frame(Year = 1964:2023, Sel = bc$S[1:60, ], Model = "h=0.7, base case")
p1 <- plot_sel()
p1
```
